---
title: Scraping Composers from Wikipedia
author: Thomas Klebel
date: '2017-10-30'
slug: scraping-composers-from-wikipedia
draft: true
categories:
  - Coding
tags:
  - R
  - Classical Music
---

In this post I will demonstrate how to download data about classical composers 
from wikipedia. Admittedly, I'm not an expert in web-scraping. The approach I
will demonstrate works for me, but there might be neater or more robust ways
to acheive the same result.

Wikipedia hast quite extensive lists on composerse of classical music. For the
purpose of informing my last post on the music played on radio swiss classic,
I wanted to add information on when the highest ranking composers lived.

I will section the post according to wikipedia's structure into baroque, 
classical era, romantic era and 20th century.

As for packages, we will use the `tidyverse` for general functions and `rvest`
for scraping the pages.

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(rvest)

# convenience function to print first few lines of data.frames
print_composers <- function(df, n = 10) df %>% head(n) %>% knitr::kable()

theme_set(hrbrmisc::theme_hrbrmstr())
```


# Baroque period
For this period, the data is in a simple list of the following format:
`'First name' 'Surname' ('date of birth' - 'date of death')`. 

```{r}
link_baroque <- "https://en.wikipedia.org/wiki/List_of_Baroque_composers"
pg <- read_html(link_baroque)

baroque_composers <- pg %>% 
  html_nodes("ul") %>%  
  .[2:9] %>%  # only those lists are of interet to us
  html_nodes("li") %>% 
  html_text() %>% 
  data_frame(complete = .)
```

In the next step we will extract the name, date of birth and of death. For this
I will define a function, since we can re-use the code for other eras too. In
this function we leverage `str_extract` from the `stringr`-package and some
regex-expressions, which I verbalise with inline comments.

```{r}
extract_info <- function(df, period) {
  df %>% 
    mutate(
      # regex: start from beginning until there is a " (", which is omitted
      composer = str_extract(complete, "^.*?(?=\\s\\()"), 
      # regex: extract the first four digits
      year_of_birth = str_extract(complete, "\\d{4}"),
      # regex: extract the last four digits, either before ")" or before "?)"
      year_of_death = str_extract(complete, "\\d{4}(?=\\??\\))")) %>% 
    select(-complete) %>% 
    mutate_at(c("year_of_birth", "year_of_death"), as.numeric) %>% 
    mutate(period = period)
}
```


After defining the function we can use it on our baroque composers: 

```{r}
baroque_composers <- baroque_composers %>% 
  extract_info("baroque")

print_composers(baroque_composers)
```

There are a few edge cases, which I didn't catch, but this should be sufficient
four our purposes.


# Classical era
For the classical era we can use the same procedure as above.

```{r}
link_classical <- "https://en.wikipedia.org/wiki/List_of_Classical-era_composers"
pg <- read_html(link_classical)

classical_composers <- pg %>% 
  html_nodes("ul") %>%  
  .[2:6] %>%  # only those lists are of interet to us
  html_nodes("li") %>% 
  html_text() %>% 
  data_frame(complete = .) %>% 
  extract_info("classical")

print_composers(classical_composers)
```


# Romantic era
```{r}
# link_romantic <- "https://en.wikipedia.org/wiki/List_of_Romantic-era_composers"
# pg <- read_html(link_romantic)
# 
# pg

```

# 20th century

```{r}
# 20th century
link_composers_20th <- "https://en.wikipedia.org/wiki/List_of_20th-century_classical_composers"
pg <- read_html(link_composers_20th)
  
table_20 <- pg %>% 
  html_node("table.wikitable") %>%
  html_table(fill = TRUE)

sortkeys <- pg %>% 
  html_node("table.wikitable") %>%
  html_nodes(css = 'span[class="sortkey"]') %>% 
  html_text()

composers_20th <- table_20 %>% 
  select(composer = Name, contains("Year")) %>% 
  rename(year_of_birth = "Year of birth", 
         year_of_death = "Year of death") %>% 
  mutate(sortkeys = sortkeys,
         composer = str_replace(composer, sortkeys, ""),
         year_of_birth = parse_number(year_of_birth),
         period = "20th_century") %>% 
  select(-sortkeys)


print_composers(composers_20th, 20)
```


# Combine all composers
```{r}
all_composers <- bind_rows(
  baroque_composers,
  classical_composers,
  composers_20th
) %>% 
  distinct()
```



```{r}
ggplot(all_composers, aes(year_of_birth, colour = period)) +
  geom_freqpoly(bins = 40)
```

Somehow there are too few people around 1800. Aaaah, thats because we miss the 
romantic era until now.

